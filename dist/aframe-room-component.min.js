!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var n in o)("object"==typeof exports?exports:e)[n]=o[n]}}(self,(()=>(()=>{function e(e){e&&e.systems.building&&e.systems.building.reexamineBuilding()}function t(t){"position"==t.detail.name&&e(t.detail.target.sceneEl)}AFRAME.registerSystem("building",{reexamineBuilding:function(){var e=this,t=1e-4;function o(e){for(var t=e.getIndex().array,o=0;o<t.length;o+=3){var n=t[o+2];t[o+2]=t[o+1],t[o+1]=n}e.getIndex().needsUpdate=!0}function n(e,t){for(var o=[],n=0;n<e.index.array.length;n++){var r=e.index.array[n],i=t(new THREE.Vector3(e.attributes.position.getX(r),e.attributes.position.getY(r),e.attributes.position.getZ(r)),n%3);o[2*r+0]=i[0],o[2*r+1]=i[1]}e.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(o),2)),e.uvsNeedUpdate=!0}function r(e,t,o,r,i){n(e,(function(e){return[e[t]*r,e[o]*i]}))}function i(e){e.computeVertexNormals(),e.computeBoundingBox(),e.computeBoundingSphere()}function a(e){for(var t=[],o=0;o<e.children.length;o++){var n=e.children[o];n.components.wall&&t.push(n)}return t}function s(e){for(var t=e.components.room.data.outside,o=a(e),n=0,r=0;r<o.length;r++){var i=o[r],s=o[(r+1)%o.length],l=i.components.position.data,m=s.components.position.data;n+=(m.x-l.x)*(m.z+l.z)}var p=!1;return n>0&&(p=!p),t&&(p=!p),p&&o.reverse(),o}var l=new THREE.Vector3,m=new THREE.Vector3,p=new THREE.Vector3;function c(e,o){var n,r,i,a=e.parentNode,c=(i=(r=s((n=a).parentNode)).indexOf(n),r[(i+1)%r.length]);if(c){a.object3D.getWorldPosition(l),c.object3D.getWorldPosition(m),o.object3D.getWorldPosition(p);var d=p.x-l.x,h=p.z-l.z,u=m.x-l.x,f=m.z-l.z,g=Math.atan2(f,u),v=Math.sqrt(u*u+f*f),y=d*Math.cos(-g)-h*Math.sin(-g),E=o.components.doorlink.data.width/2;y=Math.max(y,E+t),y=Math.min(y,v-E-t),e.setAttribute("position",{x:y,y:0,z:0}),e.object3D.updateMatrixWorld()}}function d(t){for(var o=e.el.querySelectorAll("[doorlink]"),n=0;n<o.length;n++){var r=o[n];if(r.components.doorlink.data.from==t)return r;if(r.components.doorlink.data.to==t)return r}}function h(e){return e.components.wall.data.height?e.components.wall.data.height:e.parentNode.components.room.data.height}e.dirty||(e.dirty=!0,setTimeout((function(){e.el.object3D.updateMatrixWorld();for(var l=0;l<e.el.children.length;l++)if((A=e.el.children[l]).components&&A.components.room){var m=A.components.room.data.width,p=A.components.room.data.length;if(m||p)if(m&&p){var u=a(A);u.length>=4?(u.length>4&&console.error("rooms with WIDTH and LENGTH should only have four walls!"),u[0].setAttribute("position",{x:0,y:0,z:0}),u[1].setAttribute("position",{x:m,y:0,z:0}),u[2].setAttribute("position",{x:m,y:0,z:p}),u[3].setAttribute("position",{x:0,y:0,z:p})):console.error("rooms with WIDTH and LENGTH must have four walls!")}else console.error("rooms with WIDTH must also have LENGTH (and vice versa)");if((x=s(A)).length>2)for(var f=0;f<x.length;f++){var g=x[f],v=(R=x[(f+1)%x.length]).components.position.data.x-g.components.position.data.x,y=R.components.position.data.z-g.components.position.data.z,E=Math.atan2(y,v);g.setAttribute("rotation",{x:0,y:-E/Math.PI*180,z:0}),g.object3D.updateMatrixWorld()}}for(var w=e.el.querySelectorAll("[doorlink]"),M=0;M<w.length;M++){var b=w[M];if(!(ae=b.components.doorlink))return;c(ae.data.from,ae.el),c(ae.data.to,ae.el)}for(l=0;l<e.el.children.length;l++){var A;if((A=e.el.children[l]).components&&A.components.room){var x,T=A.components.room.data.outside;if((x=s(A)).length>2){for(f=0;f<x.length;f++){g=x[f],v=(R=x[(f+1)%x.length]).components.position.data.x-g.components.position.data.x,y=R.components.position.data.z-g.components.position.data.z;for(var R,H=Math.sqrt(v*v+y*y),z=(E=Math.atan2(y,v),R.components.position.data.y-g.components.position.data.y),k=h(R)-h(g),j=[],F=0;F<g.children.length;F++){var V=g.children[F];V.components&&V.components.doorhole&&j.push(V)}j.sort((function(e,t){return e.components.position.data.x-t.components.position.data.x}));var C=new THREE.Shape;C.moveTo(0,h(g)),C.lineTo(0,0);for(var D=0;D<j.length;D++){var S=j[D];S.myVerts||(S.myVerts=[]),S.myVerts.length=0;var G=d(j[D]);if(G)for(var N=S.components,P=G.components,W=function(){function e(e){var t=new THREE.Vector3(ee,e,0);g.object3D.localToWorld(t),S.myVerts.push(t)}ee=N.position.data.x+P.doorlink.data.width/2*B,O=(I=ee/H*z)+P.doorlink.data.height,L=h(g)+ee/H*k,O>(q=I+L-t)&&(O=q),e(I),e(O),B<0?(C.lineTo(ee,I),C.lineTo(ee,O)):(C.lineTo(ee,O),C.lineTo(ee,I))},B=-1;B<=1;B+=2){var I,O,L,q;W()}}C.lineTo(H,R.components.position.data.y-g.components.position.data.y),C.lineTo(H,R.components.position.data.y-g.components.position.data.y+h(R));var X=new THREE.ShapeGeometry(C);r(X,"x","y",1,1),i(X);var Y=g.components.material?g.components.material.material:g.parentNode.components.material.material;g.myMesh?(g.myMesh.geometry=X,g.myMesh.material=Y):(g.myMesh=new THREE.Mesh(X,Y),g.setObject3D("wallMesh",g.myMesh))}for(var Z=[],U=0;U<A.children.length;U++){var J=A.children[U];J.components&&(J.components.floor||J.components.ceiling)&&Z.push(J)}for(var K=0;K<Z.length;K++){var Q=Z[K],$=Q.components.ceiling,_=new THREE.Shape;for(f=0;f<x.length;f++){var ee=(g=x[f]).components.position.data.x,te=g.components.position.data.z;f?_.lineTo(ee,te):_.moveTo(ee,te)}var oe=new THREE.ShapeGeometry(_);for(f=0;f<x.length;f++){g=x[f];var ne=new THREE.Vector3(oe.attributes.position.getX(f),oe.attributes.position.getY(f),oe.attributes.position.getZ(f));ne.set(ne.x,g.components.position.data.y,ne.y),$&&(ne.y+=h(g)),oe.attributes.position.setXYZ(f,ne.x,ne.y,ne.z)}var re=!1;$||(re=!re),T&&(re=!re),re&&o(oe),r(oe,"x","z",$?1:-1,1),i(oe),Q.myMeshes||(Q.myMeshes=[]);var ie=$?"ceiling":"floor";Y=Q.components.material?Q.components.material.material:Q.parentNode.components.material.material,Q.myMeshes[ie]?(Q.myMeshes[ie].geometry=oe,Q.myMeshes[ie].material=Y):(Q.myMeshes[ie]=new THREE.Mesh(oe,Y),Q.setObject3D(ie,Q.myMeshes[ie]))}}}}for(M=0;M<w.length;M++){var ae;if(b=w[M],(ae=b.components.doorlink).data.from&&ae.data.to){if(!ae.data.from.myVerts)return;if(!ae.data.to.myVerts)return;for(var se=0;se<b.children.length;se++){var le=b.children[se];if(le.components)for(var me=["sides","floor","ceiling"],pe=function(){if(de=me[ce],!le.components[de])return"continue";function e(e){var t=e.clone();le.object3D.worldToLocal(t),ge.push(t.x,t.y,t.z)}function t(){fe.setAttribute("position",new THREE.BufferAttribute(new Float32Array(ge),3))}switch(Y=le.components.material?le.components.material.material:le.parentNode.components.material.material,le.myGeoms||(le.myGeoms=[]),le.myGeoms[de]||(fe=new THREE.BufferGeometry,le.myGeoms[de]=fe,he=new THREE.Mesh(fe,Y),fe.meshRef=he,le.setObject3D(de,he),(ue=[]).push(0,1,2,1,3,2),"sides"==de&&ue.push(4,5,6,5,7,6),fe.setIndex(ue)),(fe=le.myGeoms[de]).meshRef.material=Y,ge=[],ve=ae.data.from.myVerts,ye=ae.data.to.myVerts,de){case"floor":e(ye[0]),e(ye[2]),e(ve[2]),e(ve[0]),t(),n(fe,(function(e,t){return[1-t%2,1-Math.floor(t/2)]}));break;case"ceiling":e(ye[3]),e(ye[1]),e(ve[1]),e(ve[3]),t(),n(fe,(function(e,t){return[t%2,1-Math.floor(t/2)]}));break;case"sides":e(ye[2]),e(ye[3]),e(ve[0]),e(ve[1]),e(ve[2]),e(ve[3]),e(ye[0]),e(ye[1]),t(),n(fe,(function(e,t){var o=[];return o[0]=Math.floor(t/2),o[1]=t%2,t<4&&(o[0]=1-o[0]),o}))}i(fe)},ce=0;ce<me.length;ce++){var de,he,ue,fe,ge,ve,ye;pe()}}}}e.dirty=!1})))}});var o={init:function(){this.lastScene=this.el.sceneEl,e(this.lastScene),this.el.addEventListener("componentchanged",t)},update:function(){e(this.lastScene)},remove:function(){e(this.lastScene),this.lastScene=null,this.el.removeEventListener("componentchanged",t)}};return AFRAME.registerComponent("room",Object.assign({schema:{outside:{type:"boolean"},height:{type:"number",default:2.4},width:{type:"number"},length:{type:"number"}}},o)),AFRAME.registerComponent("wall",Object.assign({schema:{height:{type:"number"}}},o)),AFRAME.registerComponent("floor",o),AFRAME.registerComponent("ceiling",o),AFRAME.registerComponent("doorhole",o),AFRAME.registerComponent("doorlink",Object.assign({schema:{from:{type:"selector"},to:{type:"selector"},height:{type:"number",default:2},width:{type:"number",default:.8}}},o)),AFRAME.registerComponent("sides",o),AFRAME.registerPrimitive("rw-room",{defaultComponents:{room:{}},mappings:{outside:"room.outside",height:"room.height",width:"room.width",length:"room.length"}}),AFRAME.registerPrimitive("rw-wall",{defaultComponents:{wall:{}},mappings:{height:"wall.height"}}),AFRAME.registerPrimitive("rw-floor",{defaultComponents:{floor:{}},mappings:{}}),AFRAME.registerPrimitive("rw-ceiling",{defaultComponents:{ceiling:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorhole",{defaultComponents:{doorhole:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorlink",{defaultComponents:{doorlink:{}},mappings:{from:"doorlink.from",to:"doorlink.to",height:"doorlink.height",width:"doorlink.width"}}),AFRAME.registerPrimitive("rw-sides",{defaultComponents:{sides:{}},mappings:{}}),{}})()));
//# sourceMappingURL=aframe-room-component.min.js.map