!function(e){function t(n){if(o[n])return o[n].exports;var r=o[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t){function o(e){e&&e.systems.building&&e.systems.building.reexamineBuilding()}function n(e){"position"==e.detail.name&&o(e.detail.target.sceneEl)}function r(){this.lastScene=this.el.sceneEl,o(this.lastScene),this.el.addEventListener("componentchanged",n)}function i(){o(this.lastScene)}function a(){o(this.lastScene),this.lastScene=null,this.el.removeEventListener("componentchanged",n)}AFRAME.registerSystem("building",{reexamineBuilding:function(){function e(e){for(var t=e.index,o=0;o<t.count/3;o++){var n=t[3*o+2];t[3*o+2]=t[3*o+1],t[3*o+1]=n}e.setIndex(t)}function t(e,t){for(var o=[],n=0;n<e.index.array.length;n++){var r=e.index.array[n],i=new THREE.Vector3(e.attributes.position.getX(r),e.attributes.position.getY(r),e.attributes.position.getZ(r)),a=t(i,n%3);o[2*r+0]=a[0],o[2*r+1]=a[1]}e.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(o),2)),e.uvsNeedUpdate=!0}function o(e,o,n,r,i){t(e,function(e){return[e[o]*r,e[n]*i]})}function n(e){e.computeVertexNormals(),e.computeBoundingBox(),e.computeBoundingSphere()}function r(e){for(var t=[],o=0;o<e.children.length;o++){var n=e.children[o];n.components.wall&&t.push(n)}return t}function i(e){for(var t=e.components.room.data.outside,o=r(e),n=0,i=0;i<o.length;i++){var a=o[i],s=o[(i+1)%o.length],l=a.components.position.data,m=s.components.position.data;n+=(m.x-l.x)*(m.z+l.z)}var p=!1;return n>0&&(p=!p),t&&(p=!p),p&&o.reverse(),o}function a(e){var t=i(e.parentNode),o=t.indexOf(e);return t[(o+1)%t.length]}function s(e,t){var o=e.parentNode,n=a(o);if(n){o.object3D.getWorldPosition(d),n.object3D.getWorldPosition(h),t.object3D.getWorldPosition(u);var r=u.x-d.x,i=u.z-d.z,s=h.x-d.x,l=h.z-d.z,m=Math.atan2(l,s),p=Math.sqrt(s*s+l*l),f=r*Math.cos(-m)-i*Math.sin(-m),g=t.components.doorlink.data.width/2;f=Math.max(f,g+c),f=Math.min(f,p-g-c),e.setAttribute("position",{x:f,y:0,z:0}),e.object3D.updateMatrixWorld()}}function l(e){for(var t=p.el.querySelectorAll("[doorlink]"),o=0;o<t.length;o++){var n=t[o];if(n.components.doorlink.data.from==e)return n;if(n.components.doorlink.data.to==e)return n}}function m(e){return e.components.wall.data.height?e.components.wall.data.height:e.parentNode.components.room.data.height}var p=this,c=1e-4,d=new THREE.Vector3,h=new THREE.Vector3,u=new THREE.Vector3;p.dirty||(p.dirty=!0,setTimeout(function(){function a(e){var t=new THREE.Vector3(q,e,0);M.object3D.localToWorld(t),W.myVerts.push(t)}function d(e){var t=e.clone();pe.object3D.worldToLocal(t),ve.push(t.x,t.y,t.z)}function h(){ue.setAttribute("position",new THREE.BufferAttribute(new Float32Array(ve),3))}p.el.object3D.updateMatrixWorld();for(var u=0;u<p.el.children.length;u++){var f=p.el.children[u];if(f.components&&f.components.room){var g=f.components.room.data.width,v=f.components.room.data.length;if(g||v)if(g&&v){var y=r(f);y.length>=4?(y.length>4&&console.error("rooms with WIDTH and LENGTH should only have four walls!"),y[0].setAttribute("position",{x:0,y:0,z:0}),y[1].setAttribute("position",{x:g,y:0,z:0}),y[2].setAttribute("position",{x:g,y:0,z:v}),y[3].setAttribute("position",{x:0,y:0,z:v})):console.error("rooms with WIDTH and LENGTH must have four walls!")}else console.error("rooms with WIDTH must also have LENGTH (and vice versa)");var E=i(f);if(E.length>2)for(var w=0;w<E.length;w++){var M=E[w],x=E[(w+1)%E.length],A=x.components.position.data.x-M.components.position.data.x,b=x.components.position.data.z-M.components.position.data.z,T=Math.atan2(b,A);M.setAttribute("rotation",{x:0,y:-T/Math.PI*180,z:0}),M.object3D.updateMatrixWorld()}}}for(var R=p.el.querySelectorAll("[doorlink]"),H=0;H<R.length;H++){var z=R[H],k=z.components.doorlink;if(!k)return;s(k.data.from,k.el),s(k.data.to,k.el)}for(var u=0;u<p.el.children.length;u++){var f=p.el.children[u];if(f.components&&f.components.room){var F=f.components.room.data.outside,E=i(f);if(E.length>2){for(var w=0;w<E.length;w++){for(var M=E[w],x=E[(w+1)%E.length],A=x.components.position.data.x-M.components.position.data.x,b=x.components.position.data.z-M.components.position.data.z,V=Math.sqrt(A*A+b*b),T=Math.atan2(b,A),j=x.components.position.data.y-M.components.position.data.y,C=m(x)-m(M),D=[],S=0;S<M.children.length;S++){var G=M.children[S];G.components&&G.components.doorhole&&D.push(G)}D.sort(function(e,t){return e.components.position.data.x-t.components.position.data.x});var N=new THREE.Shape;N.moveTo(0,m(M)),N.lineTo(0,0);for(var P=0;P<D.length;P++){var W=D[P];W.myVerts||(W.myVerts=[]),W.myVerts.length=0;var B=l(D[P]);if(B)for(var O=W.components,I=B.components,L=-1;L<=1;L+=2){var q=O.position.data.x+I.doorlink.data.width/2*L,X=q/V*j,Y=X+I.doorlink.data.height,Z=m(M)+q/V*C,U=X+Z-c;Y>U&&(Y=U),a(X),a(Y),L<0?(N.lineTo(q,X),N.lineTo(q,Y)):(N.lineTo(q,Y),N.lineTo(q,X))}}N.lineTo(V,x.components.position.data.y-M.components.position.data.y),N.lineTo(V,x.components.position.data.y-M.components.position.data.y+m(x));var J=new THREE.ShapeGeometry(N);o(J,"x","y",1,1),n(J);var K=M.components.material?M.components.material.material:M.parentNode.components.material.material;M.myMesh?(M.myMesh.geometry=J,M.myMesh.material=K):(M.myMesh=new THREE.Mesh(J,K),M.setObject3D("wallMesh",M.myMesh))}for(var Q=[],$=0;$<f.children.length;$++){var _=f.children[$];_.components&&(_.components.floor||_.components.ceiling)&&Q.push(_)}for(var ee=0;ee<Q.length;ee++){for(var te=Q[ee],oe=te.components.ceiling,ne=new THREE.Shape,w=0;w<E.length;w++){var M=E[w],q=M.components.position.data.x,re=M.components.position.data.z;w?ne.lineTo(q,re):ne.moveTo(q,re)}for(var ie=new THREE.ShapeGeometry(ne),w=0;w<E.length;w++){var M=E[w],ae=new THREE.Vector3(ie.attributes.position.getX(w),ie.attributes.position.getY(w),ie.attributes.position.getZ(w));ae.set(ae.x,M.components.position.data.y,ae.y),oe&&(ae.y+=m(M)),ie.attributes.position.setXYZ(w,ae.x,ae.y,ae.z)}var se=!1;oe||(se=!se),F&&(se=!se),se&&e(ie),o(ie,"x","z",oe?1:-1,1),n(ie),te.myMeshes||(te.myMeshes=[]);var le=oe?"ceiling":"floor",K=te.components.material?te.components.material.material:te.parentNode.components.material.material;te.myMeshes[le]?(te.myMeshes[le].geometry=ie,te.myMeshes[le].material=K):(te.myMeshes[le]=new THREE.Mesh(ie,K),te.setObject3D(le,te.myMeshes[le]))}}}}for(var H=0;H<R.length;H++){var z=R[H],k=z.components.doorlink;if(k.data.from&&k.data.to){if(!k.data.from.myVerts)return;if(!k.data.to.myVerts)return;for(var me=0;me<z.children.length;me++){var pe=z.children[me];if(pe.components)for(var ce=["sides","floor","ceiling"],de=0;de<ce.length;de++){var he=ce[de];if(pe.components[he]){var K=pe.components.material?pe.components.material.material:pe.parentNode.components.material.material;if(pe.myGeoms||(pe.myGeoms=[]),!pe.myGeoms[he]){var ue=new THREE.BufferGeometry;pe.myGeoms[he]=ue;var fe=new THREE.Mesh(ue,K);ue.meshRef=fe,pe.setObject3D(he,fe);var ge=[];ge.push(0,1,2,1,3,2),"sides"==he&&ge.push(4,5,6,5,7,6),ue.setIndex(ge)}var ue=pe.myGeoms[he];ue.meshRef.material=K;var ve=[],ye=k.data.from.myVerts,Ee=k.data.to.myVerts;switch(he){case"floor":d(Ee[0]),d(Ee[2]),d(ye[2]),d(ye[0]),h(),t(ue,function(e,t){return[1-t%2,1-Math.floor(t/2)]});break;case"ceiling":d(Ee[3]),d(Ee[1]),d(ye[1]),d(ye[3]),h(),t(ue,function(e,t){return[t%2,1-Math.floor(t/2)]});break;case"sides":d(Ee[2]),d(Ee[3]),d(ye[0]),d(ye[1]),d(ye[2]),d(ye[3]),d(Ee[0]),d(Ee[1]),h(),t(ue,function(e,t){var o=[];return o[0]=Math.floor(t/2),o[1]=t%2,t<4&&(o[0]=1-o[0]),o})}n(ue)}}}}}p.dirty=!1}))}});var s={init:r,update:i,remove:a};AFRAME.registerComponent("room",Object.assign({schema:{outside:{type:"boolean"},height:{type:"number",default:2.4},width:{type:"number"},length:{type:"number"}}},s)),AFRAME.registerComponent("wall",Object.assign({schema:{height:{type:"number"}}},s)),AFRAME.registerComponent("floor",s),AFRAME.registerComponent("ceiling",s),AFRAME.registerComponent("doorhole",s),AFRAME.registerComponent("doorlink",Object.assign({schema:{from:{type:"selector"},to:{type:"selector"},height:{type:"number",default:2},width:{type:"number",default:.8}}},s)),AFRAME.registerComponent("sides",s),AFRAME.registerPrimitive("rw-room",{defaultComponents:{room:{}},mappings:{outside:"room.outside",height:"room.height",width:"room.width",length:"room.length"}}),AFRAME.registerPrimitive("rw-wall",{defaultComponents:{wall:{}},mappings:{height:"wall.height"}}),AFRAME.registerPrimitive("rw-floor",{defaultComponents:{floor:{}},mappings:{}}),AFRAME.registerPrimitive("rw-ceiling",{defaultComponents:{ceiling:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorhole",{defaultComponents:{doorhole:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorlink",{defaultComponents:{doorlink:{}},mappings:{from:"doorlink.from",to:"doorlink.to",height:"doorlink.height",width:"doorlink.width"}}),AFRAME.registerPrimitive("rw-sides",{defaultComponents:{sides:{}},mappings:{}})}]);